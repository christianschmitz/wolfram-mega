<html>
    <head>

    </head>
    
    <body>
        <h1>Wofram Mega Node Monitor:</h1>
        <hr>

        Peers: <div id="peers"></div>

        <hr>

        <h2>Oracles:</h2>

        <div id="oracles"></div>
        <br>
        
        <label for="pubkey">Oracle PubKey:</label>
        <input type="text" id="pubkey" size="50" name="pubkey" value="AAA">

        <input type="button" id="oracle" value="Register Oracle!">


        <hr>

        <h2>Capabilities:</h2>

        <div id="capabilities"></div>
        <br>

        <label for="question">Question:</label>
        <input type="text" id="question" size="50" name="question" value="Who won?">
        <input type="button" id="capability" value="Register Capability!">
        

        <hr>

        <h2>Reports:</h2>

        <div id="reports"></div>
        <br>

        <label for="content">Content:</label>
        <input type="text" id="content" name="content" size="100" value='{ "type": "fact-disagreees-with-public", "request": { "capabilityPubKey": "", "arguments": {} }, "pow": {"preimageType": "", "difficukty":0, "algorithm": "", "hash": "BBB"}}'>
        <input id="report" type="button" value="Submit Report">


    </body>

    <script>
        window.getSHA256Hash = async (input) => {
            const textAsBuffer = new TextEncoder().encode(input);
            const hashBuffer = await window.crypto.subtle.digest("SHA-256", textAsBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hash = hashArray
                .map((item) => item.toString(16).padStart(2, "0"))
                .join("");
            return hash;
        };

        const oracleForm = document.getElementById('oracle');
        const pubkey = document.getElementById('pubkey');
        oracleForm.onclick = function(event){
            const xhr = new XMLHttpRequest();
            xhr.open('POST','./oracle')
            xhr.setRequestHeader("Content-Type", "application/json");

            oracle = {"seqNo": 1, "cTTL": 0, "pow": {"preimageType": "", "difficukty":0, "algorithm": "", "hash": "BBB"}, "bid": {"amount" : 0, "proof": ""}}
            oracle.pubkey = pubkey.value
            xhr.send(JSON.stringify(oracle));

            xhr.onreadystatechange = function() {
                if (xhr.readyState == XMLHttpRequest.DONE) {
                    alert(xhr.responseText)
                }
            }
        }

        const capabilityForm = document.getElementById('capability');
        const question = document.getElementById('question');
        capabilityForm.onclick = function(event){
            const xhr = new XMLHttpRequest();
            xhr.open('POST','./capability')
            xhr.setRequestHeader("Content-Type", "application/json");

            capability = {"seqNo": 1, "cTTL": 0, pow: {"preimageType": "", "difficukty":0, "algorithm": "", "hash": "BBB"}, "oracleSignature": ""}
            capability.oraclePubKey = pubkey.value
            capability.question = question.value
            xhr.send(JSON.stringify(capability));

            xhr.onreadystatechange = function() {
                if (xhr.readyState == XMLHttpRequest.DONE) {
                    alert(xhr.responseText)
                }
            }
        }

        const reportForm = document.getElementById('report');
        const content = document.getElementById('content');
        reportForm.onclick = function(event){
            const xhr = new XMLHttpRequest();
            xhr.open('POST','./report')
            xhr.setRequestHeader("Content-Type", "application/json");

            report = {"seqNo": 1, "cTTL": 0,  pow: {"preimageType": "", "difficukty":0, "algorithm": "", "hash": "BBB"}}
            report.oraclePubKey = pubkey.value
            report.content = JSON.parse(content.value)
 

            xhr.send(JSON.stringify(report));

            xhr.onreadystatechange = function() {
                if (xhr.readyState == XMLHttpRequest.DONE) {
                    alert(xhr.responseText)
                }
            }
        }

        const oracleTable = document.getElementById('oracles');
        setInterval(() => {
            const xhr = new XMLHttpRequest();
            xhr.open('GET','./oracles')
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.send()
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState == XMLHttpRequest.DONE) {
                    const oracles = JSON.parse(xhr.responseText)
                    oracleTable.innerHTML = oracles.map(x => x.pubkey).join("<br>")
                    
                }
            }


        }, 1000)

        const capabilityTable = document.getElementById('capabilities');

        setInterval(() => {
            const xhr = new XMLHttpRequest();
            xhr.open('GET','./capabilities?pubkey=' + pubkey.value)
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.send()
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState == XMLHttpRequest.DONE) {
                    const capabilities = JSON.parse(xhr.responseText)
                    capabilityTable.innerHTML = capabilities.map(x => x.question).join("<br>")
                }
            }


        }, 1000)


        const reportsTable = document.getElementById('reports');
        setInterval(() => {
            var xhr = new XMLHttpRequest();
            
            xhr.open('GET','./reports?pubkey=' + pubkey.value)
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.send()
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState == XMLHttpRequest.DONE) {
                    const reports = JSON.parse(xhr.responseText)
                    console.log(reports.length)
                    reportsTable.innerHTML = reports.map(x => JSON.stringify(x)).join("<br>")
                }
            }


        }, 1000)

        const peersTable = document.getElementById('peers');
        setInterval(() => {
            var xhr = new XMLHttpRequest();
            
            xhr.open('GET','./peers')
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.send()
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState == XMLHttpRequest.DONE) {
                    
                    peersTable.innerHTML = xhr.responseText
                }
            }


        }, 1000)
            
    </script>
</html>