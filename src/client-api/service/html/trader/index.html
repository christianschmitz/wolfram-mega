<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
    </head>
    
    <body bgcolor="green">
        <h1>Trader Console</h1>
        

        <h2>Database</h2>

       
        <label for="view">View:</label>
        <select name="view" id="view">
            <option value="oracles">Oracles</option>
            <option value="cps">Capabilities</option>
            <option value="offers">Offers</option>
            <option value="reports">Reports</option>
            <option value="issued-reports">IssuedOffers</option>
            <option value="issued-offers">IssuedReports</option>
        </select>
        <label for="page">Page:</label>
        <input type="number" id="page" name="page" min="0" max="100" value="0"/>
        <label for="update">Update:</label>
        <input type="checkbox" id="update" name="update" checked />
        <hr>
        <div id="database"></div>
        <hr>
        <br>
        <label for="hash">Delete by pubkey/hash:</label>
        <input type="text" id="hash" size="20" name="hash" value="">
        <input type="button" id="delete" value="Delete">

        <h2>Collectors</h2>
        <label for="oracle_filter">Oracle Filter:</label>
        <input type="text" id="oracle_filter" size="40" name="oracle_filter" value="true">

        <label for="cp_filter">Capability Filter:</label>
        <input type="text" id="cp_filter" size="40" name="cp_filter" value="true">
        <br><br>
        <label for="report_filter">Report Filter:</label>
        <input type="text" id="report_filter" size="40" name="report_filter" value="true">

        <label for="offer_filter">Offer Filter:</label>
        <input type="text" id="offer_filter" size="40" name="offer_filter" value="true">



        <br><br>
        <input type="button" id="col_oracles" value="Collect Oracles">
        <input type="button" id="col_cps" value="Collect Capabilities">
        <br><br>
        <input type="button" id="col_reports" value="Collect Reports">
        <input type="button" id="col_offers" value="Collect Offers">
        <br><br>
        <label for="tag">Collector Tag:</label>
        <input type="text" id="tag" size="40" name="tag" value="tag1">
        <br><br>
        Collector List: <div id="collectors">[]</div>
        <br>
        <input type="button" id="cancel_collector" value="Cancel Collector">


        <h2>Query Oracle</h2>

        <pre>
aquire commitment from oracle
aquire fact from oracle
        </pre>

        <h2>Trade</h2>
        <pre>
generate plutus and btc contracts
submit opening transaction
use fact in the closing transaction
submit report
        </pre>
        


    </body>
    <script>
        fetch('./broadcastIssuedOffers')
        fetch('./broadcastIssuedReports')

        document.getElementById('col_oracles').onclick = async () => {
            const tag = document.getElementById('tag').value
            const opredicate = document.getElementById('oracle_filter').value
            await fetch('./collectOracles?tag=' + encodeURIComponent(tag), {
	            method: 'post',
	            body: JSON.stringify({
                    predicate: opredicate
                }),
	            headers: {'Content-Type': 'application/json'}
            })
        }

        document.getElementById('col_cps').onclick = async () => {
            const tag = document.getElementById('tag').value
            const opredicate = document.getElementById('oracle_filter').value
            const predicate = document.getElementById('cp_filter').value
            await fetch('./collectCapabilities?tag=' + encodeURIComponent(tag), {
	            method: 'post',
	            body: JSON.stringify({
                    oquery: opredicate,
                    opredicate,
                    predicate
                }),
	            headers: {'Content-Type': 'application/json'}
            })
        }

        document.getElementById('col_reports').onclick = async () => {
            const tag = document.getElementById('tag').value
            const opredicate = document.getElementById('oracle_filter').value
            const predicate = document.getElementById('report_filter').value
            await fetch('./collectReports?tag=' + encodeURIComponent(tag), {
	            method: 'post',
	            body: JSON.stringify({
                    oquery: opredicate,
                    opredicate,
                    predicate
                }),
	            headers: {'Content-Type': 'application/json'}
            })
        }

        document.getElementById('col_offers').onclick = async () => {
            const tag = document.getElementById('tag').value
            const cpquery = document.getElementById('cp_filter').value
            const predicate = document.getElementById('offer_filter').value
            await fetch('./collectOffers?tag=' + encodeURIComponent(tag), {
	            method: 'post',
	            body: JSON.stringify({
                    cpquery,
                    cppredicate,
                    predicate
                }),
	            headers: {'Content-Type': 'application/json'}
            })
        }

        document.getElementById('cancel_collector').onclick = async () => {
            const tag = document.getElementById('tag').value
                await fetch('./cancelCollector?tag=' + encodeURIComponent(tag))
        }

        document.getElementById('delete').onclick = async () => {
            const hash = document.getElementById('hash').value
            const view = document.getElementById('view').value
            const endpoints = {
                "oracles": "deleteOracle",
                "cps": "deleteCapability",
                "reports": "deleteReport",
                "offers": "deleteOffer",
                "issued-reports": "deleteIssuedReport",
                "issued-offers": "deleteIssuedOffer"
            }
            await fetch(`./${endpoints[view]}?pubkey=${encodeURIComponent(hash)}`)
        }

        setInterval(async () => {
            const collectors = await (await fetch('./listCollectors')).json()
            const target = document.getElementById('collectors')

            target.innerHTML = "<pre>" + JSON.stringify(collectors) + "</pre>"

        }, 1000)

        setInterval(async () => {
            if (document.getElementById('update').checked) {
                const page = document.getElementById('page').value
                const target = document.getElementById('database')
                const view = document.getElementById('view').value
                const endpoints = {
                    "oracles": "listOracles",
                    "cps": "listCapabilities",
                    "reports": "listReports",
                    "offers": "listOffers",
                    "issued-reports": "listIssuedReports",
                    "issued-offers": "listIssuedOffers"
                }
                const data = await (await fetch(`./${endpoints[view]}?pageSize=100&pageNo=${page}`)).json()

                const html = data.map(datum => {
                    const formats = {
                        "oracles": datum.pubkey,
                        "cps": `${datum.question} pub=${datum.capabilityPubKey}`,
                        "reports": `oracle_pub=${datum.oraclePubKey}\n   content=${JSON.stringify(datum.content)}\n   pow=${JSON.stringify(datum.pow)}`,
                        "offers": `${JSON.stringify(datum.content)} pow=${JSON.stringify(datum.pow)}`,
                        "issued-reports": `oracle_pub=${datum.oraclePubKey}\n   content=${JSON.stringify(datum.content)}\n   pow=${JSON.stringify(datum.pow)}`,
                        "issued-offers": `${JSON.stringify(datum.content)} pow=${JSON.stringify(datum.pow)}`
                    }
                    return formats[view]
                }).join("\n")
                target.innerHTML = "<pre>" + html + "</pre>"
            }
            

        }, 1000)

        
    </script>
</html>