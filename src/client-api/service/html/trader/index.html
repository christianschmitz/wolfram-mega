<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
    </head>
    
    <body bgcolor="green">
        <h1>Trader Console</h1>
        

        <h2>Database</h2>

       
        <label for="view">View:</label>
        <select name="view" id="view">
            <option value="oracles">Oracles</option>
            <option value="cps">Capabilities</option>
            <option value="offers">Offers</option>
            <option value="reports">Reports</option>
            <option value="issued-offers">IssuedOffers</option>
            <option value="issued-reports">IssuedReports</option>
        </select>
        <label for="page">Page:</label>
        <input type="number" id="page" name="page" min="0" max="100" value="0"/>
        <label for="update">Update:</label>
        <input type="checkbox" id="update" name="update" checked />
        <hr>
        <div id="database"></div>
        <hr>
        <label for="hash">Delete by pubkey/hash:</label>
        <input type="text" id="hash" size="20" name="hash" value="">
        <input type="button" id="delete" value="Delete">

        <hr>
        <h2>Collectors</h2>
        <label for="oracle_filter">Oracle Filter:</label>
        <input type="text" id="oracle_filter" size="40" name="oracle_filter" value="true">

        <label for="cp_filter">Capability Filter:</label>
        <input type="text" id="cp_filter" size="40" name="cp_filter" value="true">
        <br><br>
        <label for="report_filter">Report Filter:</label>
        <input type="text" id="report_filter" size="40" name="report_filter" value="true">

        <label for="offer_filter">Offer Filter:</label>
        <input type="text" id="offer_filter" size="40" name="offer_filter" value="true">



        <br><br>
        <input type="button" id="col_oracles" value="Collect Oracles">
        <input type="button" id="col_cps" value="Collect Capabilities">
        <br><br>
        <input type="button" id="col_reports" value="Collect Reports">
        <input type="button" id="col_offers" value="Collect Offers">
        <br><br>
        <label for="tag">Collector Tag:</label>
        <input type="text" id="tag" size="40" name="tag" value="tag1">
        <br><br>
        Collector List: <div id="collectors">[]</div>
        <br>
        <input type="button" id="cancel_collector" value="Cancel Collector">
        <hr>
        <h2>Matching</h2>

        <pre>
1. find suitable oracle
2. submit offer OR find appropriate offer
        </pre>

        <label for="offer">Offer Content:</label>
        <input type="text" id="offer" size="40" name="offer" value='{"message":"","customContract":"","terms":{"question":{"capabilityPubKey":"MIGbMBAGByqGSM49AgEGBSuBBAAjA4GGAAQACueFRtmeL2wZF83Y5gDMjQFmcv2ovTjTQUfUbz5OEU3c3CVMLpxOFm/t/CoEA04qBXlROqY0BwmOF7R53ZodCd8ATqIqeEH1/bVZ66cO2IyS/UowYX/CfBMZEKbeMCn2LHJrfQEq29iXXtpZSecEZJBs1bDcT1zx8WGZ8tg8zbUxGGs=","arguments":{}},"partyBetsOn":[],"counterPartyBetsOn":[],"partyBetAmount":0,"counterpartyBetAmount":0},"blockchain":"bitcoin-testnet","transactionToBeCoSigned":"","contact":""}'>
        <br><br>
        <label for="offer_pow">Offer PoW:</label>
        <input type="text" id="offer_pow" size="40" name="offer_pow" value='{"difficulty":2,"algorithm":"SHA256","hash":"b2d387f4c00c6ac6f5a2a10cb3caba7a0749b9f28e22394129706f22d3b82f00","magicNo":31,"magicString":""}'>
        
        <br><br>
        <input type="button" id="submit_offer" value="Issue Offer">

        <hr>
        <h2>Query Oracle</h2>
        
        <pre>endpoint:</pre><pre id="endpoint"></pre>
        
        <label for="fact_req">Fact Request:</label>
        <input type="text" id="fact_req" name="fact_req" size="40" value='{ "capabilityPubKey": "", "arguments": {} }'>
        <input id="get_commitment" type="button" value="Request Commitment">
        <br><br>
        <label for="commitment">Commitment:</label>
        <input type="text" id="commitment" name="commitment" size="40" value=''>

  
    
 
        <pre>fact:</pre><pre id="fact"></pre>

        <hr>
        <h4>Report Oracle</h4>
        <label for="oracle_pub">Oracle Pub:</label>
        <input type="text" id="oracle_pub" name="oracle_pub" size="40" value=''>
        <br><br>
        <label for="report">Report Content:</label>
        <input type="text" id="report" name="report" size="40" value='{ "type": "fact-disagreees-with-public", "request": { "capabilityPubKey": "", "arguments": {} }}'>
        <br><br>
        <label for="report_pow">Report Pow:</label>
        <input type="text" id="report_pow" name="report_pow" size="40" value='{"magicNo": 1000, "difficulty":0, "algorithm": "SHA256", "hash": "ba7816bf8f01cfea414140de5dae2223b00361a396177a9cb410ff61f20015ad"}'>
        <br><br>
        <input id="submit_report" type="button" value="Issue Report">
        <hr>
        

        <h2>Trade</h2>



        <label for="terms"><h5>Offer Terms:</h5></label>
        <input type="text" id="terms" name="terms" size="80" value='{"question":{"capabilityPubKey":"MIGbMBAGByqGSM49AgEGBSuBBAAjA4GGAAQACueFRtmeL2wZF83Y5gDMjQFmcv2ovTjTQUfUbz5OEU3c3CVMLpxOFm/t/CoEA04qBXlROqY0BwmOF7R53ZodCd8ATqIqeEH1/bVZ66cO2IyS/UowYX/CfBMZEKbeMCn2LHJrfQEq29iXXtpZSecEZJBs1bDcT1zx8WGZ8tg8zbUxGGs=","arguments":{}},"partyBetsOn":["YES"],"counterPartyBetsOn":["NO"],"partyBetAmount":100,"counterpartyBetAmount":200}'>

        <h5>tx-in ("txid # out"):</h5>
        <label for="alice_in_txout">Alice:</label>
        <input type="text" id="alice_in_txout" name="alice_in_txout" size="20" value=''>
        <label for="bob_in_txout">Bob:</label>
        <input type="text" id="bob_in_txout" name="bob_in_txout" size="20" value=''>
        <br><br>
        <input id="opening_helios" type="button" value="Gen Opening Tx (Helios)">
        <input id="opening_btc" type="button" value="Gen Opening Tx (BTC)">
        <pre>opening tx: </pre><pre id="opening_tx"></pre>
        
        <h5>tx-out-addr (bech32 or btc-pubkey):</h5>
        <label for="alice_out_addr">Alice:</label>
        <input type="text" id="alice_out_addr" name="alice_out_addr" size="20" value=''>
        <label for="bob_out_addr">Bob:</label>
        <input type="text" id="bob_out_addr" name="bob_out_addr" size="20" value=''>
 
        <br><br>
        <input id="closing_helios" type="button" value="Gen Closing Tx (Helios)">
        <input id="closing_btc" type="button" value="Gen Closing Tx (Btc)">
        <pre>closing tx: </pre><pre id="closing_tx"></pre>
        <hr>
        <h4>Sign and Broadcast</h4>
        <label for="tx">Tx:</label>
        <input type="text" id="unsigned_tx" name="bob_in_txout" size="40" value=''>
        <input id="sign_helios" type="button" value="Sign (Helios)">
        <input id="sign_btc" type="button" value="Sign (BTC)">
        <pre>signed tx: </pre><pre id="signed_tx"></pre>
        <pre>signed tx id: </pre><pre id="signed_tx_id"></pre>
        <input id="broadcast_helios" type="button" value="Broadcast (Helios, testnet)">
        <input id="sign_btc" type="button" value="Broadcast (BTC, testnet)">


    </body>
    <script src="https://helios.hyperion-bt.org/0.16.7/helios.js" type="module" crossorigin></script>
    <script>
        fetch('./broadcastIssuedOffers')
        fetch('./broadcastIssuedReports')

        document.getElementById('col_oracles').onclick = async () => {
            const tag = document.getElementById('tag').value
            const opredicate = document.getElementById('oracle_filter').value
            await fetch('./collectOracles?tag=' + encodeURIComponent(tag), {
	            method: 'post',
	            body: JSON.stringify({
                    predicate: opredicate
                }),
	            headers: {'Content-Type': 'application/json'}
            })
        }

        document.getElementById('col_cps').onclick = async () => {
            const tag = document.getElementById('tag').value
            const opredicate = document.getElementById('oracle_filter').value
            const predicate = document.getElementById('cp_filter').value
            await fetch('./collectCapabilities?tag=' + encodeURIComponent(tag), {
	            method: 'post',
	            body: JSON.stringify({
                    oquery: opredicate,
                    opredicate,
                    predicate
                }),
	            headers: {'Content-Type': 'application/json'}
            })
        }

        document.getElementById('col_reports').onclick = async () => {
            const tag = document.getElementById('tag').value
            const opredicate = document.getElementById('oracle_filter').value
            const predicate = document.getElementById('report_filter').value
            await fetch('./collectReports?tag=' + encodeURIComponent(tag), {
	            method: 'post',
	            body: JSON.stringify({
                    oquery: opredicate,
                    opredicate,
                    predicate
                }),
	            headers: {'Content-Type': 'application/json'}
            })
        }

        document.getElementById('col_offers').onclick = async () => {
            const tag = document.getElementById('tag').value
            const cpquery = document.getElementById('cp_filter').value
            const predicate = document.getElementById('offer_filter').value
            await fetch('./collectOffers?tag=' + encodeURIComponent(tag), {
	            method: 'post',
	            body: JSON.stringify({
                    cpquery,
                    cppredicate: cpquery,
                    predicate
                }),
	            headers: {'Content-Type': 'application/json'}
            })
        }

        document.getElementById('submit_offer').onclick = async () => {
            const content = JSON.parse(document.getElementById('offer').value)
            const pow = JSON.parse(document.getElementById('offer_pow').value)
            const msg = { seqNo: 0, cTTL: 0, pow, content }
            await fetch('./issueOffer', {
	            method: 'post',
	            body: JSON.stringify(msg),
	            headers: {'Content-Type': 'application/json'}
            })
        }

        document.getElementById('submit_report').onclick = async () => {
            const content = JSON.parse(document.getElementById('report').value)
            const pow = JSON.parse(document.getElementById('report_pow').value)
            const oraclePubKey = document.getElementById('oracle_pub').value
            const msg = { seqNo: 0, cTTL: 0, oraclePubKey, pow, content }
            await fetch('./issueReport', {
	            method: 'post',
	            body: JSON.stringify(msg),
	            headers: {'Content-Type': 'application/json'}
            })
        }

        document.getElementById('cancel_collector').onclick = async () => {
            const tag = document.getElementById('tag').value
            await fetch('./cancelCollector?tag=' + encodeURIComponent(tag))
        }

        document.getElementById('delete').onclick = async () => {
            const hash = document.getElementById('hash').value
            const view = document.getElementById('view').value
            const endpoints = {
                "oracles": "deleteOracle",
                "cps": "deleteCapability",
                "reports": "deleteReport",
                "offers": "deleteOffer",
                "issued-reports": "deleteIssuedReport",
                "issued-offers": "deleteIssuedOffer"
            }
            await fetch(`./${endpoints[view]}?pubkey=${encodeURIComponent(hash)}`)
        }

        document.getElementById('get_commitment').onclick = async () => {
            const req = JSON.parse(document.getElementById('fact_req').value)
            const endpoint = await (await fetch('./capabilityEndpoint?pubkey=' + encodeURIComponent(req.capabilityPubKey))).json()
            if (endpoint === '') return
            const commitment = (await fetch(endpoint + '/requestCommitment', {
	            method: 'post',
	            body: JSON.stringify(req),
	            headers: {'Content-Type': 'application/json'}
            })).json()
            document.getElementById('commitment').value = JSON.stringify(commitment)

        }

        document.getElementById('opening_helios').onclick = async () => {
            const terms = JSON.parse(document.getElementById('terms').value)
            if (document.getElementById('alice_in_txout').value === "") {
                document.getElementById('alice_in_txout').value = "a00fa40eb81720cf2bd58564d1625f8340d222eaa2fe4d87c26eca0793eb01dd # 0"
            }

            if (document.getElementById('bob_in_txout').value === "") {
                document.getElementById('bob_in_txout').value = "a00fa40eb81720cf2bd58564d1625f8340d222eaa2fe4d87c26eca0793eb01dd # 1"
            }

            if (document.getElementById('alice_out_addr').value === "") {
                document.getElementById('alice_out_addr').value = "addr_test1vp8cprhse9pnnv7f4l3n6pj0afq2hjm6f7r2205dz0583egagfjah"
            }

            if (document.getElementById('bob_out_addr').value === "") {
                document.getElementById('bob_out_addr').value = "addr_test1vp8cprhse9pnnv7f4l3n6pj0afq2hjm6f7r2205dz0583egagfjah"
            }

            const alice_txin = document.getElementById('alice_in_txout').value
            const bob_txin = document.getElementById('bob_in_txout').value
            const alice_addr_out = document.getElementById('alice_out_addr').value
            const bob_addr_out = document.getElementById('bob_out_addr').value

            const inputs = {
                aliceInput: {
                    txid: alice_txin.split(" # ")[0],
                    txout: parseInt(alice_txin.split(" # ")[1]),
                    amount: terms.partyBetAmount,
                    addr: alice_addr_out
                }, 
                bobInput: {
                    txid: bob_txin.split(" # ")[0],
                    txout: parseInt(bob_txin.split(" # ")[1]),
                    amount: terms.counterpartyBetAmount,
                    addr: bob_addr_out
                },
                oraclePubKey: terms.question.capabilityPubKey,
                r: {
                    aliceRedemptionAddr: alice_addr_out,
                    aliceBetsOnMsg: terms.partyBetsOn,
                    bobRedemptionAddr: bob_addr_out,
                    bobBetsOnMsg: terms.counterPartyBetsOn
                }
            }
            const tx = await (await fetch('./generateOpeningTransaction', {
	            method: 'post',
	            body: JSON.stringify(inputs),
	            headers: {'Content-Type': 'application/json'}
            })).json()
            document.getElementById('opening_tx').innerHTML = tx

        }

        document.getElementById('closing_helios').onclick = async () => {
            const terms = JSON.parse(document.getElementById('terms').value)
            const alice_txin = document.getElementById('alice_in_txout').value
            const bob_txin = document.getElementById('bob_in_txout').value
            const alice_addr_out = document.getElementById('alice_out_addr').value
            const bob_addr_out = document.getElementById('bob_out_addr').value
            //TODO finalize opening tx
            const openingTxId = "a00fa40eb81720cf2bd58564d1625f8340d222eaa2fe4d87c26eca0793eb01dd" 

            const fact = (() => {
                const mock = {
                    factWithQuestion: terms.partyBetsOn[0],
                    signatureType: "SHA256",
                    signature: "NULL"
                }
                try {
                    
                    const parsed = JSON.parse(document.getElementById('fact').innerHTML)
                    if (parsed.factWithQuestion === undefined) {
                        document.getElementById('fact').innerHTML = JSON.stringify(mock)
                        return mock
                    }
                    return parsed
                } catch {
                    document.getElementById('fact').innerHTML = JSON.stringify(mock)
                    return mock
                }     
            })()

            const inputs = {
                input: {
                    txid: openingTxId,
                    txout: 0,
                    amount: terms.partyBetAmount + terms.counterpartyBetAmount,
                }, 
                aliceInput: {
                    txid: alice_txin.split(" # ")[0],
                    txout: parseInt(alice_txin.split(" # ")[1]),
                    amount: terms.partyBetAmount,
                    addr: alice_addr_out
                }, 
                bobInput: {
                    txid: bob_txin.split(" # ")[0],
                    txout: parseInt(bob_txin.split(" # ")[1]),
                    amount: terms.counterpartyBetAmount,
                    addr: bob_addr_out
                },
                oraclePubKey: terms.question.capabilityPubKey,
                msg: fact.factWithQuestion,
                sig: fact.signature,
                r: {
                    aliceRedemptionAddr: alice_addr_out,
                    aliceBetsOnMsg: terms.partyBetsOn,
                    bobRedemptionAddr: bob_addr_out,
                    bobBetsOnMsg: terms.counterPartyBetsOn
                }
            }
            const tx = await (await fetch('./generateClosingTransaction', {
	            method: 'post',
	            body: JSON.stringify(inputs),
	            headers: {'Content-Type': 'application/json'}
            })).json()
            document.getElementById('closing_tx').innerHTML = tx

        }


        document.getElementById('sign_helios').onclick = async () => {
            const handle = await window.cardano.eternl.enable()
            const walletAPI = new Cip30Wallet(handle)
            const walletHelper = new WalletHelper(walletAPI)
            const changeAddr = await walletHelper.changeAddress
            const txRaw = document.getElementById('unsigned_tx').value
            const tx = Tx.fromCbor(txRaw)
            const networkParams = new NetworkParams(
                await fetch("https://d1t0d7c2nekuk0.cloudfront.net/preprod.json")
                     .then(response => response.json())
            )
            await tx.finalize(networkParams, changeAddr)
            const signatures = await walletAPI.signTx(tx)
            tx.addSignatures(signatures)
            document.getElementById('signed_tx').innerHTML = tx.toCborHex()
            document.getElementById('signed_tx_id').innerHTML = tx.id().toCborHex()
        }

        document.getElementById('broadcast_helios').onclick = async () => {
            const handle = await window.cardano.eternl.enable()
            const walletAPI = new Cip30Wallet(handle)
            const walletHelper = new WalletHelper(walletAPI)
            const txRaw = document.getElementById('signed_tx').value
            const tx = Tx.fromCbor(txRaw)
            await walletAPI.submitTx(tx)
        }

        setInterval(async () => {
            if (document.getElementById('update').checked) {
                const req = JSON.parse(document.getElementById('fact_req').value)
                const endpoint = await (await fetch('./capabilityEndpoint?pubkey=' + encodeURIComponent(req.capabilityPubKey))).json()
                document.getElementById('endpoint').innerHTML = endpoint
                if (endpoint === '') return
 
                const commitment = document.getElementById('commitment').value
                const fact = (await fetch(endpoint + '/requestFact', {
                    method: 'post',
                    body: commitment,
                    headers: {'Content-Type': 'application/json'}
                })).json()
                document.getElementById('fact').innerHTML = JSON.stringify(fact)
            }
        }, 1000) 

        setInterval(async () => {
            if (document.getElementById('update').checked) {
                const collectors = await (await fetch('./listCollectors')).json()
                const target = document.getElementById('collectors')

                target.innerHTML = "<pre>" + JSON.stringify(collectors) + "</pre>"
            }

        }, 1000)

        setInterval(async () => {
            if (document.getElementById('update').checked) {
                const page = document.getElementById('page').value
                const target = document.getElementById('database')
                const view = document.getElementById('view').value
                const endpoints = {
                    "oracles": "listOracles",
                    "cps": "listCapabilities",
                    "reports": "listReports",
                    "offers": "listOffers",
                    "issued-reports": "listIssuedReports",
                    "issued-offers": "listIssuedOffers"
                }
                const data = await (await fetch(`./${endpoints[view]}?pageSize=100&pageNo=${page}`)).json()

                const html = data.map(datum => {
                    const formats = {
                        "oracles": `pub=${datum.pubkey}`,
                        "cps": `${datum.question} pub=${datum.capabilityPubKey} endpoint=${(datum.endpoint ?? '')}`,
                        "reports": `oracle_pub=${datum.oraclePubKey}\n   content=${JSON.stringify(datum.content)}\n   pow=${JSON.stringify(datum.pow)}`,
                        "offers": `${JSON.stringify(datum.content)} pow=${JSON.stringify(datum.pow)}`,
                        "issued-reports": `oracle_pub=${datum.oraclePubKey}\n   content=${JSON.stringify(datum.content)}\n   pow=${JSON.stringify(datum.pow)}`,
                        "issued-offers": `${JSON.stringify(datum.content)} pow=${JSON.stringify(datum.pow)}`
                    }
                    return formats[view]
                }).join("\n")
                target.innerHTML = "<pre>" + html + "</pre>"
            }
            

        }, 1000)

        
    </script>
    <script src="https://helios.hyperion-bt.org/0.16.7/helios.js" type="module" crossorigin></script>

</html>